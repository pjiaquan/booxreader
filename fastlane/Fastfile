default_platform(:android)

platform :android do
  desc "Capture screenshots using the ADB script"
  lane :screenshots do
    # In a real Fastlane setup with Ruby installed, you might use 'screengrab'
    # But here we use our custom PowerShell script for simplicity on Windows/FOSS.
    sh "powershell -ExecutionPolicy Bypass -File tools/capture_screenshots.ps1"
  end

  desc "Build the Debug APK"
  lane :build_debug do
    gradle(task: "installDebug")
  end
  
  desc "Build the Release APK (Unsigned)"
  lane :build_release do
    gradle(task: "assembleRelease")
  end

  desc "Upload release bundle to Google Play Internal track"
  lane :play_internal do |options|
    # Support both inline JSON and file path
    json_key = ENV["SUPPLY_JSON_KEY_FILE"] || ENV["SUPPLY_JSON_KEY"] || ENV["GOOGLE_PLAY_JSON_KEY"] || ENV["GOOGLE_APPLICATION_CREDENTIALS"]
    UI.user_error!("Set SUPPLY_JSON_KEY_FILE or SUPPLY_JSON_KEY (or GOOGLE_PLAY_JSON_KEY / GOOGLE_APPLICATION_CREDENTIALS) to your Play service account JSON") if json_key.to_s.empty?

    aab_path = options[:aab] || "app/build/outputs/bundle/release/app-release.aab"

    # Only build if the AAB doesn't exist at the specified path (CI usually downloads it)
    unless File.exist?(aab_path)
      gradle(task: "bundleRelease")
      aab_path = "app/build/outputs/bundle/release/app-release.aab"
    end

    supply(
      json_key: json_key,
      package_name: "my.hinoki.booxreader",
      track: "internal",
      aab: aab_path,
      skip_upload_screenshots: true,
      skip_upload_images: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: true
    )
  end

  desc "Upload release bundle to Google Play Closed Beta track"
  lane :play_closed_beta do |options|
    # Support both inline JSON and file path
    json_key = ENV["SUPPLY_JSON_KEY_FILE"] || ENV["SUPPLY_JSON_KEY"] || ENV["GOOGLE_PLAY_JSON_KEY"] || ENV["GOOGLE_APPLICATION_CREDENTIALS"]
    UI.user_error!("Set SUPPLY_JSON_KEY_FILE or SUPPLY_JSON_KEY (or GOOGLE_PLAY_JSON_KEY / GOOGLE_APPLICATION_CREDENTIALS) to your Play service account JSON") if json_key.to_s.empty?

    # Increment version code to avoid conflict with internal track
    # This updates the versionCode and versionName in build.gradle.kts
    sh("../gradlew :app:incrementVersionCode")

    # Clean build output to ensure we use the new version
    sh("../gradlew clean")

    # Build with new version code
    gradle(task: "bundleRelease")
    aab_path = "app/build/outputs/bundle/release/app-release.aab"

    # Upload to closed beta track
    supply(
      json_key: json_key,
      package_name: "my.hinoki.booxreader",
      track: "beta",
      aab: aab_path,
      skip_upload_screenshots: true,
      skip_upload_images: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: true
    )
  end
end

default_platform(:android)

platform :android do
  desc "Capture screenshots using the ADB script"
  lane :screenshots do
    # In a real Fastlane setup with Ruby installed, you might use 'screengrab'
    # But here we use our custom PowerShell script for simplicity on Windows/FOSS.
    sh "powershell -ExecutionPolicy Bypass -File tools/capture_screenshots.ps1"
  end

  desc "Build the Debug APK"
  lane :build_debug do
    gradle(task: "installDebug")
  end
  
  desc "Build the Release APK (Unsigned)"
  lane :build_release do
    gradle(task: "assembleRelease")
  end

  desc "Upload release bundle to Google Play Internal track"
  lane :play_internal do
    json_key = ENV["SUPPLY_JSON_KEY"] || ENV["GOOGLE_PLAY_JSON_KEY"] || ENV["GOOGLE_APPLICATION_CREDENTIALS"]
    UI.user_error!("Set SUPPLY_JSON_KEY (or GOOGLE_PLAY_JSON_KEY / GOOGLE_APPLICATION_CREDENTIALS) to your Play service account JSON") if json_key.to_s.empty?

    gradle(task: "bundleRelease")

    supply(
      json_key: json_key,
      package_name: "my.hinoki.booxreader",
      track: "internal",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      skip_upload_screenshots: true,
      skip_upload_images: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: true
    )
  end
end

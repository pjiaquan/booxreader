# GEMINI.md - Project Audit & Improvement Plan

## Overview
This document outlines the improvement plan for the `booxreader` project, focusing on Refactoring, Testing, Documentation, Optimization, and Security.

## 1. Refactoring (Architecture & Code Quality)
- **Current Status:** `ReaderActivity` acts as a "God Object". `ReaderViewModel` has tight coupling with `Application` context and instantiates Repositories directly, making testing difficult.
- **Plan:** 
    - Implement Dependency Injection (DI) pattern. Refactor `ReaderViewModel` to accept Repositories via constructor.
    - Create `ViewModelFactory` to manage dependencies.
    - Consolidate data persistence logic (SharedPrefs, DB, Network) into the Repository layer.

## 2. Testing
- **Current Status:** Minimal to no unit test coverage. Logic is hard to test due to coupling.
- **Plan:**
    - Create Unit Tests for `ReaderViewModel` (after refactoring for DI).
    - Mock Repositories to verify business logic (e.g., `saveProgress`, `postTextToServer`).

## 3. Documentation
- **Current Status:** Inconsistent comments, mixed languages.
- **Plan:**
    - Add KDoc to key classes (`ReaderViewModel`, `BookRepository`).
    - Ensure strict English-only comments for maintainability.

## 4. Optimization
- **Current Status:** `isMinifyEnabled = false` in Release builds. Heavy text processing on the main/default thread in some areas.
- **Plan:**
    - Enable R8/ProGuard minification for release builds.
    - Ensure regex operations and heavy parsing are offloaded to `Dispatchers.Default`.

## 5. Security & Data Safety
- **Current Status:** `fallbackToDestructiveMigration()` is enabled in `AppDatabase`. This risks user data loss on updates.
- **Plan:**
    - **CRITICAL:** Remove `fallbackToDestructiveMigration()`. Implement `Migration` path or at least disable destructive fallback to force manual migration handling.
    - Ensure network calls use secure endpoints (HTTPS).

## Security Guide for EPUBs
To ensure the safety of EPUB books and the reader application, we follow these best practices:

1.  **Scan for Malware (Sandboxing & Analysis):**
    *   **Implementation:** Added "Verify File (Hash)" and **"Run Safety Scan"** in Reader Settings.
    *   **Safety Scan:** This tool unzips the EPUB in memory (without executing it) and scans for:
        *   Suspicious file extensions (`.js`, `.exe`, `.bat`).
        *   Embedded scripts (`<script>` tags, `javascript:` links) within HTML content.
    *   **User Action:** Run this scan for any file from an untrusted source.

2.  **Verify Source:**
    *   **Practice:** Only download books from trusted repositories (e.g., Project Gutenberg, Standard Ebooks).
    *   **Verification:** Use the "Verify File Hash" tool to confirm integrity against the publisher's checksum.

3.  **Use Trusted Readers (Sandboxing):**
    *   **Technology:** The app uses Readium, which runs within the Android WebView sandbox.
    *   **Recommendation:** We strongly recommend users do *not* enable "Publisher Styles" or "Javascript" if prompted (defaults are off).

4.  **Disable External Content:**
    *   **Current State:** The app disables `publisherStyles` by default to prevent malicious CSS overlays.

5.  **Update Software:**
    *   **Maintenance:** Keep the app updated to ensure the underlying WebView and Readium libraries have the latest security patches.

## Recent Updates
- **Feature:** Added **"Run Safety Scan"** to detect embedded scripts and executable files inside EPUBs.
- **Feature:** Added "Verify File Hash" to calculate SHA-256 checksums.
- **Feature:** Server Base URL changes now apply immediately without requiring an app restart.
- **Refactoring:** Updated Publishers to use a dynamic URL provider lambda.
- **Feature:** Added configurable Server Base URL in Reader Settings (requires app restart to apply).
- **Refactoring:** Updated `HttpConfig`, `AiNoteRepository`, `BookmarkRepository`, and `ReaderViewModel` to support dynamic base URLs.
- **UI Fix:** cleared text selection and dismissed context menu automatically after clicking "Publish".
- **UI Fix:** Prevented the text selection context menu from disappearing after clicking "Publish" in `ReaderActivity`.
- **Refactoring:** Updated `ReaderViewModel` to use constructor injection for better testability.
- **Testing:** Added `Mockito` and `Coroutines Test` dependencies; created unit tests for `ReaderViewModel`.
- **Security:** Removed `fallbackToDestructiveMigration()` from `AppDatabase` to prevent accidental data loss.
- **Optimization:** Enabled `isMinifyEnabled = true` for release builds.

---
*Generated by Gemini Senior Developer Agent*
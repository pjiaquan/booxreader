# AI Note Firestore Sync Implementation Plan

This document explains how `AiNoteDetail` (AI Notes) are saved to Google Cloud Firestore, detailing the data flow, structure, and types.

## 1. Overview
The application uses a "Local First" architecture. Notes are first saved to the local SQLite database (via Room) and then synchronized to Firestore for cross-device availability.

## 2. Data Flow

1.  **User Action:** User highlights text and requests an AI explanation or adds a note in the Reader UI.
2.  **Repository Layer (`AiNoteRepository`):**
    *   The `add()` or `update()` method is called.
    *   **Local Save:** The note is inserted/updated in the local Room database (`AiNoteEntity`).
    *   **Sync Trigger:** The repository calls `syncRepo.pushNote(savedNote)` to initiate the cloud sync.
3.  **Sync Layer (`UserSyncRepository`):**
    *   **Authentication Check:** Verifies the user is logged in via Firebase Auth.
    *   **Mapping:** Converts the local `AiNoteEntity` to a network-optimized `RemoteAiNote` object.
    *   **Firestore Write:** Writes the data to the `users/{userId}/ai_notes` collection.

## 3. Firestore Data Structure

*   **Root Collection:** `users`
*   **Document ID:** `{userId}` (The Firebase Auth UID)
*   **Sub-collection:** `ai_notes`
*   **Document ID:** `{remoteId}` (A UUID generated by the app or Firestore)

### Field Details (`RemoteAiNote`)

| Field Name | Firestore Type | Kotlin Type | Description |
| :--- | :--- | :--- | :--- |
| `remoteId` | String | `String` | Unique ID for the note in Firestore. Used for syncing back to local DB. |
| `bookId` | String | `String?` | The unique ID (MD5/Hash) of the book this note belongs to. |
| `bookTitle` | String | `String?` | Title of the book (cached for display without needing the book file). |
| `originalText` | String | `String` | The original text selected by the user in the book. |
| `aiResponse` | String | `String` | The content of the note or the AI's generated explanation. |
| `locatorJson` | String | `String?` | JSON string containing the EPUB CFI (Canonical Fragment Identifier) to locate the text in the book. |
| `createdAt` | Number | `Long` | Timestamp (milliseconds since epoch) when the note was created. |
| `updatedAt` | Number | `Long` | Timestamp (milliseconds since epoch) of the last update. Used for conflict resolution. |

## 4. Code References

*   **Repository:** `app/src/main/java/my/hinoki/booxreader/data/repo/AiNoteRepository.kt`
    *   Handles business logic and coordinates local/remote saving.
*   **Sync Logic:** `app/src/main/java/my/hinoki/booxreader/data/repo/UserSyncRepository.kt`
    *   `pushNote()`: Handles the actual write to Firestore.
    *   `pullNotes()`: Downloads remote notes to local storage.
*   **Data Models:**
    *   `AiNoteEntity`: Local Room database entity.
    *   `RemoteAiNote`: Data transfer object for Firestore (defined in `UserSyncRepository.kt`).

## 5. Security Rules (Implied)
*   **Read/Write:** Users can only read and write to documents within their own `users/{userId}` path.

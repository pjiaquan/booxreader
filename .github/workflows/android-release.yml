name: Android Release APK

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    name: Build release APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Compute artifact names
        id: names
        run: |
          APP_NAME=$(sed -n 's/.*name="app_name">\([^<]*\)<\/string>.*/\1/p' app/src/main/res/values/strings.xml | head -n 1)
          VERSION_NAME=$(sed -n 's/^[[:space:]]*versionName[[:space:]]*=[[:space:]]*"\([^"]*\)".*/\1/p' app/build.gradle.kts | head -n 1)
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "apk_unsigned=dist/${APP_NAME}-${VERSION_NAME}-release-unsigned.apk" >> $GITHUB_OUTPUT
          echo "apk_signed=dist/${APP_NAME}-${VERSION_NAME}-release.apk" >> $GITHUB_OUTPUT
          echo "aab_path=dist/${APP_NAME}-${VERSION_NAME}-release.aab" >> $GITHUB_OUTPUT

      - name: Build release APK & AAB
        run: ./gradlew assembleRelease bundleRelease

      - name: Prepare artifacts folder
        run: |
          mkdir -p dist
          cp app/build/outputs/apk/release/app-release-unsigned.apk "${{ steps.names.outputs.apk_unsigned }}"
          cp app/build/outputs/bundle/release/app-release.aab "${{ steps.names.outputs.aab_path }}"

      - name: Decode signing keystore (optional)
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > dist/release.keystore
            echo "Keystore decoded."
          else
            echo "No ANDROID_KEYSTORE_BASE64 provided; skipping keystore decode."
          fi

      - name: Sign release artifacts (optional)
        continue-on-error: true
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_ALIAS_PASSWORD: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
          ANDROID_HOME: /usr/local/lib/android/sdk
          APK_UNSIGNED: ${{ steps.names.outputs.apk_unsigned }}
          APK_SIGNED: ${{ steps.names.outputs.apk_signed }}
          AAB_PATH: ${{ steps.names.outputs.aab_path }}
        run: |
          if [ -f dist/release.keystore ] && \
             [ -n "${KEYSTORE_PASSWORD:-}" ] && \
             [ -n "${KEY_ALIAS:-}" ] && \
             [ -n "${KEY_ALIAS_PASSWORD:-}" ]; then
            BUILD_TOOLS=$(ls "$ANDROID_HOME/build-tools" | sort -V | tail -n 1)
            "$ANDROID_HOME/build-tools/$BUILD_TOOLS/apksigner" sign \
              --ks dist/release.keystore \
              --ks-pass pass:$KEYSTORE_PASSWORD \
              --ks-key-alias "$KEY_ALIAS" \
              --key-pass pass:$KEY_ALIAS_PASSWORD \
              --out "$APK_SIGNED" \
              "$APK_UNSIGNED"
            jarsigner -keystore dist/release.keystore -storepass "$KEYSTORE_PASSWORD" -keypass "$KEY_ALIAS_PASSWORD" "$AAB_PATH" "$KEY_ALIAS"
            rm -f "$APK_UNSIGNED"
            echo "Signing completed; outputs: $APK_SIGNED and $AAB_PATH"
          else
            echo "Signing skipped (keystore or credentials missing); unsigned artifacts kept."
          fi

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-release-artifacts
          path: dist/*

  publish:
    name: Attach APK to GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download built artifact
        uses: actions/download-artifact@v4
        with:
          name: app-release-artifacts
          path: dist

      - name: Publish GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: |
            Automated release build from CI.
          artifacts: "dist/*.apk,dist/*.aab"
          allowUpdates: true
